CREATE DATABASE QLCB;
USE QLCB;

CREATE TABLE KHACHHANG(
	MAKH VARCHAR(15) PRIMARY KEY,
	TEN NVARCHAR(15) NOT NULL,
	DCHI NVARCHAR(50) NOT NULL,
	DTHOAI VARCHAR(12) CHECK (DTHOAI regexp '[0-9]')
);

CREATE TABLE NHANVIEN(
	MANV VARCHAR(15) PRIMARY KEY,
	TEN NVARCHAR(15) NOT NULL,
	DCHI NVARCHAR(50) NOT NULL,
	DTHOAI VARCHAR(12)  CHECK (DTHOAI regexp '[0-9]'),
	LUONG DECIMAL(10, 2) NOT NULL CHECK (LUONG > 0),
	LOAINV BIT NOT NULL
);

CREATE TABLE LOAIMB(
	MALOAI VARCHAR(15) PRIMARY KEY,
	HANGSX NVARCHAR(15) NOT NULL
);

CREATE TABLE MAYBAY(
	SOHIEU INT,
	MALOAI VARCHAR(15),
	PRIMARY KEY(SOHIEU, MALOAI),
    FOREIGN KEY(MALOAI) REFERENCES LOAIMB(MALOAI)
);

CREATE TABLE CHUYENBAY(
	MACB VARCHAR(4) PRIMARY KEY,
	SBDI VARCHAR(3) NOT NULL,
	SBDEN VARCHAR(3) NOT NULL,
	GIODI TIME NOT NULL,
	GIODEN TIME NOT NULL
);

CREATE TABLE LICHBAY(
	NGAYDI DATE,
	MACB VARCHAR(4),
	SOHIEU INT NOT NULL,
	MALOAI VARCHAR(15) NOT NULL,
	PRIMARY KEY(NGAYDI, MACB),
    FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB),
    FOREIGN KEY (SOHIEU, MALOAI) REFERENCES MAYBAY(SOHIEU, MALOAI)
);

CREATE TABLE DATCHO(
	MAKH VARCHAR(15),
	NGAYDI DATE,
	MACB VARCHAR(4),
	PRIMARY KEY(MAKH, NGAYDI, MACB),
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
    FOREIGN KEY (NGAYDI, MACB) REFERENCES LICHBAY(NGAYDI, MACB)
);

CREATE TABLE KHANANG(
	MANV VARCHAR(15),
	MALOAI VARCHAR(15),
	PRIMARY KEY(MANV, MALOAI),
    FOREIGN KEY(MALOAI) REFERENCES LOAIMB(MALOAI),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
);

CREATE TABLE PHANCONG(
	MANV VARCHAR(15),
	NGAYDI DATE,
	MACB VARCHAR(4),
	PRIMARY KEY(MANV, NGAYDI, MACB),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY(NGAYDI, MACB) REFERENCES LICHBAY(NGAYDI, MACB)
);

INSERT INTO KHACHHANG VALUES('0009', 'Nga', '223 Nguyen Trai', '8932320');
INSERT INTO KHACHHANG VALUES('0101', 'Anh', '567 Tran Phu', '8826729');
INSERT INTO KHACHHANG VALUES('0045', 'Thu', '285 Le Loi', '8932203');
INSERT INTO KHACHHANG VALUES('0012', 'Ha', '435 Quang Trung', '8933232');
INSERT INTO KHACHHANG VALUES('0238', 'Hung', '456 Pasteur', '9812101');
INSERT INTO KHACHHANG VALUES('0397', 'Thanh', '234 Le Van Si', '8952943');
INSERT INTO KHACHHANG VALUES('0582', 'Mai', '789 Nguyen Du', NULL);
INSERT INTO KHACHHANG VALUES('0934', 'Minh', '678 Le Lai', NULL);
INSERT INTO KHACHHANG VALUES('0091', 'Hai', '345 Hung Vuong', '8893223');
INSERT INTO KHACHHANG VALUES('0314', 'Phuong', '395 Vo Van Tan','8232320');
INSERT INTO KHACHHANG VALUES('0613', 'Vu', '348 CMT8', '8343232');
INSERT INTO KHACHHANG VALUES('0586', 'Son', '123 Bach Dang', '8556223');
INSERT INTO KHACHHANG VALUES('0422', 'Tien', '75 Nguyen Thong', '8332222');

INSERT INTO NHANVIEN VALUES('1006', 'Chi', '12/6 Nguyen Kiem', '8120012', 150000, 0);
INSERT INTO NHANVIEN VALUES('1005', 'Giao', '65 Nguyen Thai Son', '8324467', 500000, 0);
INSERT INTO NHANVIEN VALUES('1001', 'Huong', '8 Dien Bien Phu', '8330733', 500000, 1);
INSERT INTO NHANVIEN VALUES('1002', 'Phong', '1 Ly Thuong Kiet', '8308117', 450000, 1);
INSERT INTO NHANVIEN VALUES('1004', 'Phuong', '351 Lac Long Quan', '8308155', 250000, 0);
INSERT INTO NHANVIEN VALUES('1003', 'Quang', '78 Truong Dinh', '8324461', 350000, 1);
INSERT INTO NHANVIEN VALUES('1007', 'Tam', '36 Nguyen Van Cu', '8458188', 500000, 0);

INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Airbus', 'A310');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Airbus', 'A320');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Airbus', 'A330');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Airbus', 'A340');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Boeing', 'B727');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Boeing', 'B747');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('Boeing', 'B757');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('MD', 'DC10');
INSERT INTO LOAIMB(HANGSX, MALOAI) VALUES('MD', 'DC9');

INSERT INTO MAYBAY VALUES(10, 'B747');
INSERT INTO MAYBAY VALUES(11, 'B727');
INSERT INTO MAYBAY VALUES(13, 'B727');
INSERT INTO MAYBAY VALUES(13, 'B747');
INSERT INTO MAYBAY VALUES(21, 'DC10');
INSERT INTO MAYBAY VALUES(21, 'DC9');
INSERT INTO MAYBAY VALUES(22, 'B757');
INSERT INTO MAYBAY VALUES(22, 'DC9');
INSERT INTO MAYBAY VALUES(23, 'DC9');
INSERT INTO MAYBAY VALUES(24, 'DC9');
INSERT INTO MAYBAY VALUES(70, 'A310');
INSERT INTO MAYBAY VALUES(80, 'A310');
INSERT INTO MAYBAY VALUES(93, 'B757');

INSERT INTO CHUYENBAY VALUES('100', 'SLC', 'BOS', '08:00', '17:50');
INSERT INTO CHUYENBAY VALUES('112', 'DCA', 'DEN', '14:00', '18:07');
INSERT INTO CHUYENBAY VALUES('121', 'STL', 'SLC', '07:00', '09:13');
INSERT INTO CHUYENBAY VALUES('122', 'STL', 'YYV', '08:30', '10:19');
INSERT INTO CHUYENBAY VALUES('206', 'DFW', 'STL', '09:00', '11:40');
INSERT INTO CHUYENBAY VALUES('330', 'JFK', 'YYV', '16:00', '18:53');
INSERT INTO CHUYENBAY VALUES('334', 'ORD', 'MIA', '12:00', '14:14');
INSERT INTO CHUYENBAY VALUES('335', 'MIA', 'ORD', '15:00', '17:14');
INSERT INTO CHUYENBAY VALUES('336', 'ORD', 'MIA', '18:00', '20:14');
INSERT INTO CHUYENBAY VALUES('337', 'MIA', 'ORD', '20:30', '23:53');
INSERT INTO CHUYENBAY VALUES('394', 'DFW', 'MIA', '19:00', '21:30');
INSERT INTO CHUYENBAY VALUES('395', 'MIA', 'DFW', '21:00', '23:43');
INSERT INTO CHUYENBAY VALUES('449', 'CDG', 'DEN', '10:00', '19:29');
INSERT INTO CHUYENBAY VALUES('930', 'YYV', 'DCA', '13:00', '16:10');
INSERT INTO CHUYENBAY VALUES('931', 'DCA', 'YYV', '17:00', '18:10');
INSERT INTO CHUYENBAY VALUES('932', 'DCA', 'YYV', '18:00', '19:10');
INSERT INTO CHUYENBAY VALUES('991', 'BOS', 'ORD', '17:00', '18:22');

INSERT INTO LICHBAY VALUES('2000-01-11', '100', 80, 'A310');
INSERT INTO LICHBAY VALUES('2000-01-11', '112', 21, 'DC10');
INSERT INTO LICHBAY VALUES('2000-01-11', '206', 22, 'DC9');
INSERT INTO LICHBAY VALUES('2000-01-11', '334', 10, 'B747');
INSERT INTO LICHBAY VALUES('2000-01-11', '395', 23, 'DC9');
INSERT INTO LICHBAY VALUES('2000-01-11', '991', 22, 'B757');
INSERT INTO LICHBAY VALUES('2000-01-11', '337', 10, 'B747');
INSERT INTO LICHBAY VALUES('2000-10-31', '100', 11, 'B727');
INSERT INTO LICHBAY VALUES('2000-10-31', '112', 11, 'B727');
INSERT INTO LICHBAY VALUES('2000-10-31', '206', 13, 'B727');
INSERT INTO LICHBAY VALUES('2000-10-31', '334', 10, 'B747');
INSERT INTO LICHBAY VALUES('2000-10-31', '335', 10, 'B747');
INSERT INTO LICHBAY VALUES('2000-10-31', '337', 24, 'DC9');
INSERT INTO LICHBAY VALUES('2000-10-31', '449', 70, 'A310');

INSERT INTO DATCHO VALUES('0009', '2000-01-11', '100');
INSERT INTO DATCHO VALUES('0009', '2000-10-31', '449');
INSERT INTO DATCHO VALUES('0045', '2000-01-11', '991');
INSERT INTO DATCHO VALUES('0012', '2000-10-31', '206');
INSERT INTO DATCHO VALUES('0238', '2000-10-31', '334');
INSERT INTO DATCHO VALUES('0582', '2000-01-11', '991');
INSERT INTO DATCHO VALUES('0091', '2000-01-11', '100');
INSERT INTO DATCHO VALUES('0314', '2000-10-31', '449');
INSERT INTO DATCHO VALUES('0613', '2000-01-11', '100');
INSERT INTO DATCHO VALUES('0586', '2000-01-11', '991');
INSERT INTO DATCHO VALUES('0586', '2000-10-31', '100');
INSERT INTO DATCHO VALUES('0422', '2000-10-31', '449');

INSERT INTO KHANANG VALUES('1001', 'B727');
INSERT INTO KHANANG VALUES('1001', 'B747');
INSERT INTO KHANANG VALUES('1001', 'DC10');
INSERT INTO KHANANG VALUES('1002', 'A320');
INSERT INTO KHANANG VALUES('1002', 'A340');
INSERT INTO KHANANG VALUES('1002', 'B757');
INSERT INTO KHANANG VALUES('1002', 'DC9');
INSERT INTO KHANANG VALUES('1003', 'A310');
INSERT INTO KHANANG VALUES('1003', 'DC9');

INSERT INTO PHANCONG VALUES('1001', '2000-01-11', '100');
INSERT INTO PHANCONG VALUES('1001', '2000-10-31', '100');
INSERT INTO PHANCONG VALUES('1002', '2000-01-11', '100');
INSERT INTO PHANCONG VALUES('1002', '2000-10-31', '100');
INSERT INTO PHANCONG VALUES('1003', '2000-10-31', '100');
INSERT INTO PHANCONG VALUES('1003', '2000-10-31', '337');
INSERT INTO PHANCONG VALUES('1004', '2000-10-31', '100');
INSERT INTO PHANCONG VALUES('1004', '2000-10-31', '337');
INSERT INTO PHANCONG VALUES('1005', '2000-10-31', '337');
INSERT INTO PHANCONG VALUES('1006', '2000-01-11', '991');
INSERT INTO PHANCONG VALUES('1006', '2000-10-31', '337');
INSERT INTO PHANCONG VALUES('1007', '2000-01-11', '112');
INSERT INTO PHANCONG VALUES('1007', '2000-01-11', '991');
INSERT INTO PHANCONG VALUES('1007', '2000-01-11', '206');

-- 1. Cho biết mã số, tên phi công, địa chỉ, điện thoại của các phi công đã từng lái máy bay loại B747
SELECT N.MANV, TEN, DCHI, DTHOAI
FROM KHANANG K INNER JOIN NHANVIEN N ON K.MANV = N.MANV
WHERE LOAINV=1 AND MALOAI='B747';

-- 2. Cho biết mã số và ngày đi của các chuyến bay xuất phát từ sân bay DCA trong khoảng thời gian từ 14 giờ đến 18 giờ.
SELECT C.MACB, NGAYDI, GIODI
FROM LICHBAY L INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SBDI='DCA' AND GIODI <= '18:00' AND GIODI >= '14:00';

-- 3. Cho biết tên những nhân viên được phân công trên chuyến bay có mã số 100 xuất phát tại sân bay SLC.
SELECT GROUP_CONCAT(DISTINCT TEN) AS 'Cac nhan vien duoc phan cong'
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV = N.MANV
				INNER JOIN LICHBAY L ON L.NGAYDI = P.NGAYDI AND L.MACB = P.MACB
				INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SBDI='SLC' AND C.MACB='100';

-- 4. Cho biết mã loại và số hiệu máy bay đã từng xuất phát tại sân bay MIA.
SELECT DISTINCT M.SOHIEU, M.MALOAI
FROM LICHBAY L INNER JOIN MAYBAY M ON L.SOHIEU = M.SOHIEU AND L.MALOAI = M.MALOAI
				INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SBDI='MIA';

-- 5. Cho biết mã chuyến bay, ngày đi, cùng với tên, địa chỉ, điện thoại của tất cả các hành khách đi trên chuyến bay đó.
--    Sắp xếp theo thứ tự tăng dần của mã chuyến bay và theo ngày đi giảm dần.
SELECT MACB, NGAYDI, TEN, DCHI, DTHOAI
FROM DATCHO D INNER JOIN KHACHHANG K ON D.MAKH = K.MAKH
ORDER BY MACB ASC, NGAYDI DESC;

-- 6. Cho biết mã chuyến bay, ngày đi, cùng với tên, địa chỉ, điện thoại của tất cả những nhân viên được phân công trong chuyến bay đó.
--	  Sắp xếp theo thứ tự tăng dần của mã chuyến bay và theo ngày đi giảm dần.
SELECT MACB, NGAYDI, TEN, DCHI, DTHOAI
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV=N.MANV
ORDER BY MACB ASC, NGAYDI DESC;

-- 7. Cho biết mã chuyến bay, ngày đi, mã số và tên của những phi công được phân công vào chuyến bay hạ cánh xuống sân bay ORD.
SELECT C.MACB, L.NGAYDI, N.MANV, TEN
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV = N.MANV
				INNER JOIN LICHBAY L ON P.NGAYDI = L.NGAYDI AND P.MACB = L.MACB
				INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SBDEN='ORD' AND LOAINV=1;

-- 8. Cho biết mã số chuyến bay, ngày đi và tên của phi công có mã 1001 được phân công lái chuyến bay đó.
SELECT MACB, NGAYDI, TEN
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV = N.MANV
WHERE N.MANV = '1001' AND LOAINV=1;

-- 9. Cho biết thông tin của những chuyến bay hạ cánh xuống DEN.
--    Các chuyến bay được liệt kê theo ngày đi giảm dần và sân bay xuất phát (SBDI) tăng dần.
SELECT C.MACB, SBDI, SBDEN, NGAYDI, GIODI, GIODEN
FROM LICHBAY L INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
ORDER BY NGAYDI DESC, SBDI ASC;

-- 10. Cho biết hãng sản xuất và mã loại máy bay mà phi công có khả năng bay được.
SELECT N.MANV, TEN, L.MALOAI, HANGSX
FROM KHANANG K INNER JOIN NHANVIEN N ON K.MANV = N.MANV
				INNER JOIN LOAIMB L ON K.MALOAI = L.MALOAI
WHERE LOAINV=1;

-- 11. Cho biết mã phi công, tên phi công đã lái máy bay trong chuyến bay mã số 100 vào ngày 11/01/2000
SELECT N.MANV, TEN
FROM LICHBAY L INNER JOIN MAYBAY M ON L.SOHIEU = M.SOHIEU AND L.MALOAI = M.MALOAI
				INNER JOIN PHANCONG P ON L.NGAYDI = P.NGAYDI AND L.MACB = P.MACB
				INNER JOIN NHANVIEN N ON P.MANV = N.MANV
WHERE L.MACB='100' AND L.NGAYDI = '2000-01-11' AND LOAINV=1;

-- 12. Cho biết mã chuyến bay, mã nhân viên, tên nhân viên được phân công vào chuyến
--     bay xuất phát ngày 10/31/2000 tại sân bay MIA vào lúc 20:30
SELECT C.MACB, N.MANV, TEN
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV = N.MANV
				INNER JOIN LICHBAY L ON P.NGAYDI = L.NGAYDI AND P.MACB = L.MACB
				INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE L.NGAYDI = '2000-10-31' AND SBDI = 'MIA' AND GIODI = '20:30';

-- 13. Cho biết thông tin về chuyến bay (mã chuyến bay, số hiệu, mã loại, hãng sản xuất) mà phi công “Quang” đã lái
SELECT L.MACB, M.SOHIEU, LMB.MALOAI, HANGSX
FROM LICHBAY L INNER JOIN PHANCONG P ON L.NGAYDI = P.NGAYDI AND L.MACB = P.MACB
				INNER JOIN NHANVIEN N ON P.MANV = N.MANV
				INNER JOIN MAYBAY M ON L.SOHIEU = M.SOHIEU AND L.MALOAI = M.MALOAI
				INNER JOIN LOAIMB LMB ON M.MALOAI = LMB.MALOAI
WHERE TEN='Quang' AND LOAINV=1;

-- 14. Cho biết tên của những phi công chưa được phân công lái chuyến bay nào
SELECT TEN
FROM NHANVIEN
WHERE NOT EXISTS(SELECT MANV FROM PHANCONG);

-- 15. Cho biết tên khách hàng đã đi chuyến bay trên máy bay của hãng 'Boeing'
SELECT GROUP_CONCAT(DISTINCT TEN)
FROM LICHBAY L INNER JOIN MAYBAY M ON L.SOHIEU = M.SOHIEU AND L.MALOAI = M.MALOAI
				INNER JOIN LOAIMB LMB ON M.MALOAI = LMB.MALOAI
				INNER JOIN DATCHO D ON D.NGAYDI = L.NGAYDI AND D.MACB = L.MACB
				INNER JOIN KHACHHANG K ON K.MAKH = D.MAKH
WHERE HANGSX='Boeing';

-- 16. Cho biết các chuyến bay chỉ bay với máy bay số hiệu 10 và mã loại B747
SELECT C.MACB, SBDI, SBDEN, NGAYDI, GIODI, GIODEN
FROM LICHBAY L INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SOHIEU=10 AND MALOAI='B747';

-- 17. Với mỗi sân bay (SBDEN), cho biết số lượng chuyến bay hạ cánh xuống sân bay đó.
--	   Kết quả được sắp xếp theo thứ tự tăng dần của sân bay đến
SELECT SBDEN, COUNT(*) 'SOLUONG'
FROM CHUYENBAY
GROUP BY SBDEN
ORDER BY SBDEN;

-- 18. Với mỗi sân bay (SBDI), cho biết số lượng chuyến bay xuất phát từ sân bay đó,
--	   sắp xếp theo thứ tự tăng dần của sân bay xuất phát.
SELECT SBDI, COUNT(*) 'SOLUONG'
FROM CHUYENBAY
GROUP BY SBDI
ORDER BY SBDI;

-- 19. Với mỗi sân bay (SBDI), cho biết số lượng chuyến bay xuất phát theo từng ngày.
SELECT SBDI, NGAYDI, COUNT(*) 'SOLUONG'
FROM CHUYENBAY C INNER JOIN LICHBAY L ON C.MACB = L.MACB
GROUP BY SBDI, NGAYDI;

-- 20. Với mỗi sân bay (SBDEN), cho biết số lượng chuyến bay hạ cánh theo từng ngày.
SELECT SBDEN, NGAYDI, COUNT(*) 'SOLUONG'
FROM CHUYENBAY C INNER JOIN LICHBAY L ON C.MACB = L.MACB
GROUP BY SBDEN, NGAYDI;

-- 21. Cho biết mã chuyến bay, ngày đi cùng với số lượng nhân viên không phải là phi công của chuyến bay đó.
SELECT MACB, NGAYDI, COUNT(*) 'SOLUONG'
FROM PHANCONG P INNER JOIN NHANVIEN N ON P.MANV = N.MANV
WHERE LOAINV <> 1
GROUP BY MACB, NGAYDI;

-- 22. Số lượng chuyến bay xuất phát từ sân bay MIA vào ngày 11/01/2000.
SELECT COUNT(*) 'SOLUONG'
FROM LICHBAY L INNER JOIN CHUYENBAY C ON L.MACB = C.MACB
WHERE SBDI='MIA' AND NGAYDI='2000-01-11';

-- 23. Với mỗi chuyến bay, cho biết mã chuyến bay, ngày đi, số lượng nhân viên được phân công trên chuyến bay đó, sắp theo thứ tự giảm dần của số lượng.